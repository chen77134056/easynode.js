<!--编辑文章-->

<style>
    .users-list>li{width: 330px;}
    #show_media_list .box-body li{border: 1px solid #fff;margin: 10px 10px;float: left;text-align: center;list-style: none;padding: 5px;}
    #show_media_list li img{width: 100px;height: 100px;display:block;margin: 0 auto;}
    .wangEditor-container .wangEditor-txt img {
        cursor: pointer;
        display: block;
    }
</style>

<section class="content">
    <div class="row">
        <div class="col-md-9">
                        <!-- Main content -->

                            <div class="form-group">
                                <label>标题：</label>  <span id="prompt_tit" style="display: none;" class="text-red">至少标题不能为空</span>
                                <input id="post_title" type="text" class="form-control" placeholder="Enter ...">
                            </div>


                            <%if(!!time){%>
                                <div class="callout callout-info" style="background:#fff !important;border-left: 5px solid #d2d6de;box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
                                    <h4 style="color: #444;">添加文章成功</h4>
                                    <p style="color: #444;"><label>固定链接：</label><span id="post_url"></span> <a style="position: relative;top:-2px;background: #fff;border-color: #d2d6de;color: #444;" id="post_url_a" href="/p/683" target="_blank" class="btn btn-primary btn-xs">查看文章</a></p>
                                </div>
                            <%}%>

                            <div class="form-group">
                                <a id="media_bt" class="btn btn-social btn-default" style="background: #fff;border-color: #d2d6de;">
                                    <i class="fa fa-instagram"></i>添加媒体
                                </a>

                                <a id="start_up" class="btn btn-primary" style="height: 34px;background: #fff;border-color: #d2d6de;color: #444;">上传</a>
                                &nbsp;
                                &nbsp;
                                &nbsp;
                                &nbsp;
                                <a id="show_media" class="btn btn-primary" style="height: 34px;background: #fff;border-color: #d2d6de;color: #444;">显示媒体</a>

                                <iframe style="visibility: hidden;position: absolute;z-index: -1;" id="iframepage" scrolling="no" class="add_post_iframe" name="ifrmname" width="200" src="/admin/haha"></iframe>
                            </div>




                            <div id="div1" style="height:500px;"></div>
                            <div class="row">
                                <div class="col-xs-12 text-center">
                                    <a id="update_post" class="btn btn-primary" style="margin-top: 5px;width: 80px;">更新</a>
                                    <a href="post_list" class="btn btn-primary" style="margin-top: 5px;width: 80px;">返回</a>
                                </div>
                            </div>

        </div>
        <!-- /.col -->
        <div class="col-md-3">
                        <%if(!!time){%>
                        <div class="form-group">
                            <label>发布时间：</label>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-calendar-times-o"></i></span>
                                <input id="time" type="text" class="form-control" disabled style="background: #fff;padding: 6px 2px;text-align: center;">
                            </div>
                        </div>
                        <%}%>

            <div class="form-group">
                <label>添加分类：</label>
                <div class="input-group" style="margin-bottom: 15px;">
                    <input id="category_name" type="text" name="message" placeholder="输入要添加的文章分类名称" class="form-control">
                    <span class="input-group-btn">
                        <a id="add_category_bt" class="btn btn-primary btn-flat">添加分类</a>
                      </span>
                </div>

                <label>分类归属：</label>
                <select id="post_category" class="form-control select2" multiple="multiple" data-placeholder="选择分类" style="width: 100%;">

                </select>

            </div>




            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">文章编辑记录</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body no-padding">
                    <table id="edit_time_list" class="table table-striped">



                    </table>
                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->




        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
</section>







<div id="show_media_list" style="display: none;">
    <section class="content">
        <div class="row">
            <div class="col-md-12">
                <div class="box">
                    <div class="box-header with-border">
                            <h3 class="box-title">媒体库</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                                </button>
                                <!--<div class="btn-group">
                                    <button type="button" class="btn btn-box-tool dropdown-toggle" data-toggle="dropdown">
                                        <i class="fa fa-wrench"></i></button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Action</a></li>
                                        <li><a href="#">Another action</a></li>
                                        <li><a href="#">Something else here</a></li>
                                        <li class="divider"></li>
                                        <li><a href="#">Separated link</a></li>
                                    </ul>
                                </div>-->
                                <a onclick="layer.close(layer.index);" class="btn btn-box-tool"><i class="fa fa-times"></i></a>
                            </div>
                    </div>
                    <div class="box-body">
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer clearfix">
                        <a id="append_bt" class="btn btn-primary">插入</a>
                        <a class="btn btn-default" onclick="layer.close(layer.index);">取消</a>

                            <ul class="pagination pagination-sm no-margin pull-right">
                                <div style="float: left;padding-right: 10px;padding-top: 5px;"><a id="cur"></a>/<a id="tol"></a></div>
                                <li><a id="pre_bt" href="#">上一页</a></li>
                                <!--<li><a href="#">1</a></li>-->
                                <!--<li><a href="#">2</a></li>-->
                                <!--<li><a href="#">3</a></li>-->
                                <li><a id="next_bt" href="#">下一页</a></li>
                            </ul>

                    </div>

                </div>
            </div>
        </div>
    </section>
</div>


<!--
<div id="show_media_list" style="display: none;background: #fff;padding: 10px;">
    <div style="">
        <div class="box-body no-padding">
            <ul class="users-list clearfix">

            </ul>
            &lt;!&ndash; /.users-list &ndash;&gt;
        </div>
    </div>


    <div class="text-center">
        <a class="btn btn-primary">插入</a>
        <a class="btn btn-default" onclick="layer.close(layer.index);">取消</a>
    </div>
</div>
-->




<script src="/layer/layer.js"></script>

<script>

    //上传文件后的回调
    function reload_media() {

    }

    function upload_success() {
        $('#show_media').trigger('click');
    }



    function printLog(title, info) {
        window.console && console.log(title, info);
    }

    // ------- 配置上传的初始化事件 -------
    function uploadInit () {
        // this 即 editor 对象
        var editor = this;
        // 编辑器中，触发选择图片的按钮的id
        var btnId = editor.customUploadBtnId;
        // 编辑器中，触发选择图片的按钮的父元素的id
        var containerId = editor.customUploadContainerId;

        //实例化一个上传对象
        var uploader = new plupload.Uploader({
            browse_button: btnId,  // 选择文件的按钮的id
            url: '/admin/upload',  // 服务器端的上传地址
            flash_swf_url: '/plupload/lib/plupload/Moxie.swf',
            sliverlight_xap_url: '/plupload/lib/plupload/Moxie.xap',
            filters: {
                mime_types: [
                    //只允许上传图片文件 （注意，extensions中，逗号后面不要加空格）
                    { title: "图片文件", extensions: "jpg,gif,png,bmp" }
                ]
            }
        });

        //存储所有图片的url地址
        var urls = [];

        //初始化
        uploader.init();

        //绑定文件添加到队列的事件
        uploader.bind('FilesAdded', function (uploader, files) {
            //显示添加进来的文件名
            $.each(files, function(key, value){
                printLog('添加文件' + value.id);
            });

            // 文件添加之后，开始执行上传
            uploader.start();
        });

        //单个文件上传之后
        uploader.bind('FileUploaded', function (uploader, file, responseObject) {
            //注意，要从服务器返回图片的url地址，否则上传的图片无法显示在编辑器中
            var url = responseObject.response;
            //先将url地址存储来，待所有图片都上传完了，再统一处理
            urls.push(url);

            printLog('一个图片上传完成，返回的url是' + url);
            reload_media();
        });

        //全部文件上传时候
        uploader.bind('UploadComplete', function (uploader, files) {
            printLog('所有图片上传完成');
            //reload_media();
            // 用 try catch 兼容IE低版本的异常情况
            try {
                //打印出所有图片的url地址
                console.log(urls)


                    // 插入到编辑器中
                    //editor.command(null, 'insertHtml', '<img src="' + value + '" style="max-width:100%;"/>');

                $.each(urls, function (key, value) {
                    printLog('即将插入图片' + value);
                    editor.$txt.append('<img src="'+ window.location.protocol+ '//'+ window.location.host+'/uploads/'+new Date().getFullYear()+'/'+(new Date().getMonth()+1)+'/'+ value + '" style="max-width:100%;"/>');

                });



            } catch (ex) {
                // 此处可不写代码
            } finally {
                //清空url数组
                urls = [];

                // 隐藏进度条
                editor.hideUploadProgress();
            }
        });

        // 上传进度条
        uploader.bind('UploadProgress', function (uploader, file) {
            // 显示进度条
            editor.showUploadProgress(file.percent);
        });
    }


    // ------- 创建编辑器 -------
    var editor = new wangEditor('div1');
    editor.config.customUpload = true;  // 配置自定义上传的开关
    editor.config.customUploadInit = uploadInit;  // 配置上传事件，uploadInit方法已经在上面定义了
    editor.create();






    //选择上传文件
    $('#media_bt').click(function () {
        $($("#iframepage")[0].contentDocument).find('body').find('#xFile').trigger('click');
        console.log($($("#iframepage")[0].contentDocument));

        //判断相应的年份是否存在
//        $.ajax({
//             type:'post',
//             url:'/admin/year_dir'
//
//        });
    });
    

    //开始上传
    $('#start_up').click(function () {
        $($("#iframepage")[0].contentDocument).find('body button').trigger('click');
    });
    
    //分类下来，ui美化
    $(".select2").select2();



    //添加文章分类
    $('#add_category_bt').click(function () {
        if(/^$/ig.test($('#category_name').val())){

        }else{
                    $.ajax({
                        url:"/admin/add_category",
                        type:'post',
                        async:false,
                        dataType : 'json',
                        data:{cat_title:$('#category_name').val()},
                        success:function (data) {

                            //更新添加分类
                            if(!!(window.location.href.split('post_edit?id=')[1])){
                                //编辑文章执行此
                                $.ajax({
                                    type:'post',
                                    async:false,
                                    url:'p/post_edit?id='+(window.location.href.split('post_edit?id=')[1]),//编辑文章跳转此链接
                                    success:function (data) {
                                        var data=JSON.parse(data);

                                        $(data[1]).each(function (a,b) {  //填充分类

                                            if(new RegExp(b.text,'i').test(data[0].category)){
                                                //$('<option selected="selected">'+b.text+'</option>').appendTo($('#post_category'));
                                            }else{
                                                $('<option>'+b.text+'</option>').appendTo($('#post_category'));
                                            }

                                        })
                                    }
                                });
                            }else{
                                $.ajax({//更新 分类归属
                                    type:'post',
                                    async:false,
                                    url:'/admin/categorizes',//编辑文章跳转此链接
                                    success:function (data) {
                                        $(data).each(function (a,b) {  //填充分类
                                            $('<option>'+b.text+'</option>').appendTo($('#post_category'));
                                        })
                                    }
                                });
                            }


                            $('#category_name').val('');
                        }
                    });
        }


    });







        if(!!(window.location.href.split('post_edit?id=')[1])){
            //编辑文章执行此
            $.ajax({
                type:'post',
                async:false,
                url:'p/post_edit?id='+(window.location.href.split('post_edit?id=')[1]),//编辑文章跳转此链接
                success:function (data) {
                    var data=JSON.parse(data);

                    $(data[1]).each(function (a,b) {  //填充分类

                        if(new RegExp(b.text,'i').test(data[0].category)){
                            $('<option selected="selected">'+b.text+'</option>').appendTo($('#post_category'));
                        }else{
                            $('<option>'+b.text+'</option>').appendTo($('#post_category'));
                        }

                    })
                    editor.$txt.html(data[0].post_con);  //填充 文本内容
                    $('#post_title').val( data[0].post_title ); //填充 文章标题
                    $('#time').val(data[0].time);


                }
            });

            $('#post_url').html(window.location.protocol+"//"+window.location.host+"/p/"+window.location.href.split('post_edit?id=')[1]);
            $('#post_url_a').attr({href:"/p/"+window.location.href.split('post_edit?id=')[1]});

            $('#update_post').click(function () {
                $.ajax({
                    type:'post',
                    async:false,
                    url:'/admin/edit_post',
                    data:{
                        post_id:parseFloat(window.location.search.split('post_edit?id=')[0].replace(/[^0-9]/ig,"")),
                        post_title:$('#post_title').val(),
                        post_con:editor.$txt.html(),
                        category:$('#post_category').val().join(','),
                        time:$('#time').val()
                    },
                    dataType : 'json',
                    success:function () {
                        var timedate=new Date();
                        $('#edit_time_list').append('<tr><td>'+timedate.getFullYear()+'-'+(timedate.getMonth()+1)+'-'+timedate.getDate()+'&nbsp;'+new Date().getHours()+':'+new Date().getMinutes()+':'+new Date().getSeconds()+'</td></tr>');
                    }
                });
            });

        }else{
            //添加文章
            $.ajax({
                type:'post',
                async:false,
                url:'/admin/categorizes',//编辑文章跳转此链接
                success:function (data) {


                    $(data).each(function (a,b) {  //填充分类

                        $('<option>'+b.text+'</option>').appendTo($('#post_category'));

                    })

                }
            });


            $('#update_post').click(function () {

                if(!$('#post_category').val()){
                    $('#post_category').val('其他')
                }

                if(!$('#post_title').val()){
                    $('#prompt_tit').show();
                    return false;
                }

                $.ajax({
                    type:'post',
                    async:false,
                    url:'/admin/add_post',
                    data:{

                        post_title:$('#post_title').val(),
                        post_con:editor.$txt.html(),
                        category:$('#post_category').val().join(','),
                        future_time_switch:false
                    },
                    dataType : 'json',
                    success:function (data) {
                        if(typeof data[0]["_id"] === 'number'){
                            window.location.href='post_edit?id='+data[0]["_id"]
                        }else{
                            alert('文章没添加成功');
                        }
                    }
                });

            });
        }









    var img_arry=[]; //存放图片数组
    function push_media_pic(page_num) {
        $.ajax({
            type:'get',
            url:'/admin/media_json2/'+page_num,
            success:function (data) {
                $('#tol').text(data[0]);
                $('#cur').text(page_num);

                data.shift();
                $('#show_media_list .box-body li').remove();
                $(data).each(function (index,value) {
               
                    var file_name=value.file_name.split('\\')[3];
                    if(new RegExp('jpg|png|gif|jpge|bmp','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/'+value.file_name+'" alt="User Image"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('rar','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/rar.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('zip','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/zip.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('html','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/html.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('css','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/css.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('gif','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/gif.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('text','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/text.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('pptx','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/pptx.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('ppt','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/ppt.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else if(new RegExp('docx','i').test(value.file_name)){
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/docx.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }else{
                        $('#show_media_list .box-body').append('<li data-realurl="'+value.file_name+'" data-clickstate="1"><img src="/icons/other.png"><a class="users-list-name" href="#">'+file_name+'</a></li>');
                    }
                });


                $('#show_media_list .box-body li').click(function () {

                    if(  parseFloat($(this).data('clickstate'))==1  ){ //选中
                        $(this).css({border:'1px solid #ccc'});
                        $(this).data('clickstate','0');


                        if(new RegExp('jpg|png|gif|jpge|bmp','i').test($(this).find('a').text())){
                            img_arry.push('<img src="'+$(this).find('img').attr('src')+'">');
                        }else{
                            img_arry.push('<a href=/'+$(this).data('realurl')+'>'+$(this)[0].innerText+'</a>');
                        }

                    }else{
                        img_arry=[];
                        var current=$(this).data('realurl');
                        $(this).css({border:'1px solid #fff'});  //不选中
                        $(this).data('clickstate','1');

                        $(img_arry).each(function (index,value) {
                            if(new RegExp(current,'i').test(value)){
                                img_arry.splice(index,1);
                            }
                        })
                    }
                });

            }
        });
    }
    push_media_pic(1);


    //添加媒体列表弹窗
      $('#show_media').click(function () {
        layer.open({
            type: 1,
            title: false,
            closeBtn: 0,
            area: ['740px','625px'],
            skin: 'layui-layer-nobg', //没有背景色
            content: $('#show_media_list')
        });
          push_media_pic(1);
          var page_bt=1;
          $('#next_bt').click(function () {
              ++page_bt
              $.ajax({
                  type:'get',
                  url:'/admin/media_json2/1',
                  success:function (data) {
                      if( !(data[0]<page_bt) ){
                          push_media_pic(page_bt);

                      }else{
                          page_bt=data[0];
                      }
                  }
              });
          });

          $('#pre_bt').click(function () {
              --page_bt
              $.ajax({
                  type:'get',
                  url:'/admin/media_json2/1',
                  success:function (data) {

                      if(page_bt>0){
                          push_media_pic(page_bt);
                      }else{
                          page_bt=1;
                      }
                  }
              });
          });
     });



    $('#append_bt').click(function () {  //将图片插入 编辑器中
        editor.$txt.html(editor.$txt.html()+img_arry.join(',').replace(new RegExp(',','ig'),''));
        img_arry=[]; //存放图片数组
        $('#show_media_list li').css({border:'1px solid #fff'}).data('clickstate','1');
        layer.close(layer.index);
    });




    //编辑器 上传图片之前 先判断是否有相应的年月目录
    window.onload=function () {
        $('.wangeditor-menu-img-picture').click(function () {
              $.ajax({
                  type:'get',
                  url:'/admin/is_folder'
              });
        });

    }





</script>